on: [push]
name: Build for reMarkable
jobs:

  build_for_remarkable:
    name: with musl
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly # TODO: stable once const-fn is in
        target: armv7-unknown-linux-musleabihf
        override: true
    - run: rustup component add rustfmt --toolchain nightly-x86_64-unknown-linux-gnu
    - run: make ujipenchars2.txt
      working-directory: marauder
    - run: make test
      working-directory: marauder
    - uses: marcopolo/cargo@master # TODO: - uses: actions-rs/cargo@v1 https://github.com/actions-rs/cargo/pull/59
      with:
        use-cross: true
        command: build
        working-directory: marauder
        args: --release --frozen --locked --offline --target armv7-unknown-linux-musleabihf
      continue-on-error: true

  whiteboard_hypercard:
    name: Whiteboard HyperCard
    # runs-on: ubuntu-latest
    runs-on: ubuntu-16.04
    steps:
    - uses: actions/checkout@v2
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        target: armv7-unknown-linux-gnueabihf
        override: true
        components: rustfmt
    - uses: marcopolo/cargo@master # TODO: - uses: actions-rs/cargo@v1 https://github.com/actions-rs/cargo/pull/59
      with:
        working-directory: marauder
        use-cross: true
        command: build
        args: --target armv7-unknown-linux-gnueabihf --release --bin whiteboard --locked #--frozen #--offline
    # - run: docker volume inspect cargo-registry >/dev/null 2>&1 || docker volume create cargo-registry
    # - run: docker pull fenollp/rust-build-remarkable
    # - working-directory: marauder
    #   run: |
    #     docker run --rm --user $(id -u):$(id -g) \
    #       -v "$PWD":/home/builder/libremarkable:rw \
    #       -v cargo-registry:/home/builder/.cargo/registry \
    #       -w /home/builder/libremarkable \
    #       fenollp/rust-build-remarkable \
    #       cargo build --release --bin whiteboard --target=armv7-unknown-linux-gnueabihf --locked #--frozen #--offline
    - run: ls -lha ./marauder/target/*/release/*
    - run: ls -lha ./marauder/target/armv7-unknown-linux-gnueabihf/release/whiteboard
